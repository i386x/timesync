- name: Check that tests_role_name variable is set
  assert:
    that:
      - tests_role_name is defined
      - tests_role_name | length > 0
    fail_msg: >
      tests_role_name variable must be set and not empty.
  changed_when: false
  delegate_to: localhost

- name: >
    Check that tests_test_checkmode and tests_test_idempotency are not both set
  assert:
    that: not (
        ( tests_test_checkmode | default(false) ) and
        ( tests_test_idempotency | default(false) )
      )
    fail_msg: >
      Either tests_test_checkmode or tests_test_idempotency can be enabled, but
      not both.
  changed_when: false
  delegate_to: localhost

- name: Create a temporary file for a static inventory
  tempfile:
    state: file
    suffix: .inventory.yml
  register: tempinventory
  changed_when: false
  delegate_to: localhost

- name: Create a static inventory from hostvars
  template:
    src: inventory.yml.j2
    dest: "{{ tempinventory.path }}"
  changed_when: false
  delegate_to: localhost
  when:
    - tempinventory is defined
    - tempinventory.path is defined

- block:
    - name: Import role {{ tests_role_name }}
      import_role:
        name: "{{ tests_role_name }}"

    - name: >
        Import role {{ tests_role_name }} via fresh Ansible instance with check
        mode enabled
      command: >
        ansible all -vv -i {{ tempinventory.path }} --check -m import_role
          -a "name={{ tests_role_name }}"
      changed_when: false
      delegate_to: localhost
      when:
        - tempinventory is defined
        - tempinventory.path is defined
        - tests_test_checkmode | default(false)

    - name: Update static inventory with recent hostvars
      template:
        src: inventory.yml.j2
        dest: "{{ tempinventory.path }}"
      changed_when: false
      delegate_to: localhost
      when:
        - tempinventory is defined
        - tempinventory.path is defined
        - tests_test_idempotency | default(false)

    - name: Import role {{ tests_role_name }} via fresh Ansible instance
      command: >
        ansible all -vv -i {{ tempinventory.path }} -m import_role
          -a "name={{ tests_role_name }}"
      register: ansible_output
      changed_when: false
      delegate_to: localhost
      when:
        - tempinventory is defined
        - tempinventory.path is defined
        - tests_test_idempotency | default(false)

    - name: Check the idempotency
      assert:
        that:
          - ansible_output.stdout.find('| CHANGED => {\n') == -1
        fail_msg: >
          Idempotency test failed. Output: {{ ansible_output.stdout_lines }}
      changed_when: false
      delegate_to: localhost
      when:
        - ansible_output is defined
        - ansible_output.stdout is defined
        - tests_test_idempotency | default(false)

  always:
    - name: Remove the temporary file
      file:
        path: "{{ tempinventory.path }}"
        state: absent
      changed_when: false
      delegate_to: localhost
      when:
        - tempinventory is defined
        - tempinventory.path is defined
